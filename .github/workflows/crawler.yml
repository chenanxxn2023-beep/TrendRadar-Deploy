name: Get Hot News

on:
  schedule:
    # æ¯å°æ—¶ç¬¬ 33 åˆ†è¿è¡Œ
    - cron: "33 * * * *"
  workflow_dispatch:

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write    # å…è®¸å†™æ–‡ä»¶
  actions: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        run: |
          if [ ! -f config/config.yaml ]; then
            echo "Error: Config missing"
            exit 1
          fi

      - name: Run crawler
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          BARK_URL: ${{ secrets.BARK_URL }}
          AI_ANALYSIS_ENABLED: ${{ secrets.AI_ANALYSIS_ENABLED }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          GITHUB_ACTIONS: true
        run: python -m trendradar

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€å‡çº§ç‰ˆã€‘æ—¢è½¬JSONï¼Œåˆè‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶ ğŸ‘‡ğŸ‘‡ğŸ‘‡
      - name: Export DB to JSON & Clean Old Files
        if: success()
        run: |
          cat <<EOF > export_and_clean.py
          import sqlite3
          import json
          import glob
          import os
          
          # ===========================
          # 1. æ¸…ç†æ—§æ–‡ä»¶ (åªä¿ç•™æœ€è¿‘7ä¸ª)
          # ===========================
          try:
              # è·å–æ‰€æœ‰ db æ–‡ä»¶å¹¶æŒ‰æ–‡ä»¶åæ’åº (æ—¥æœŸæ–‡ä»¶åå¯ä»¥ç›´æ¥æ’åº)
              db_files = sorted(glob.glob('output/news/*.db'))
              
              # å¦‚æœè¶…è¿‡ 7 ä¸ªï¼Œåˆ é™¤æ—§çš„
              KEEP_DAYS = 7
              if len(db_files) > KEEP_DAYS:
                  files_to_delete = db_files[:-KEEP_DAYS] # å–å‡ºé™¤äº†æœ€å7ä¸ªä¹‹å¤–çš„æ‰€æœ‰æ–‡ä»¶
                  for f in files_to_delete:
                      os.remove(f)
                      print(f"ğŸ—‘ï¸ Cleanup: Deleted old database {f}")
              else:
                  print("âœ… Storage is clean (within 7 days).")
                  
          except Exception as e:
              print(f"âš ï¸ Warning during cleanup: {e}")
          
          # ===========================
          # 2. å¯¼å‡ºæœ€æ–°çš„ JSON
          # ===========================
          try:
              # é‡æ–°è·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆå› ä¸ºåˆšæ‰å¯èƒ½åˆ é™¤äº†ï¼‰
              list_of_files = glob.glob('output/news/*.db')
              if not list_of_files:
                  print("âš ï¸ No DB files found, skipping export.")
                  exit(0)
              
              latest_file = max(list_of_files, key=os.path.getctime)
              print(f"ğŸ“– Reading Database: {latest_file}")
              
              conn = sqlite3.connect(latest_file)
              cursor = conn.cursor()
              
              cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
              tables = [t[0] for t in cursor.fetchall()]
              
              final_data = {}
              
              for table in tables:
                  cursor.execute(f"SELECT * FROM {table}")
                  cols = [description[0] for description in cursor.description]
                  rows = cursor.fetchall()
                  final_data[table] = [dict(zip(cols, row)) for row in rows]
              
              output_file = 'output/daily_hot_news.json'
              with open(output_file, 'w', encoding='utf-8') as f:
                  json.dump(final_data, f, ensure_ascii=False, indent=2)
              
              print(f"âœ… Successfully exported JSON to: {output_file}")
              
          except Exception as e:
              print(f"âŒ Error exporting JSON: {e}")
              exit(1)
          EOF
          
          python export_and_clean.py

      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # ä½¿ç”¨ git add -A ä¼šè‡ªåŠ¨å¤„ç†æ–°å¢å’Œåˆ é™¤çš„æ–‡ä»¶
          git add -A output/
          git commit -m "Auto update data (Cleaned old history)" -a || exit 0
          git push
